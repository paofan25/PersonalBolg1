{"ast":null,"code":"import \"core-js/modules/es.array.push.js\";\nimport \"core-js/modules/es.iterator.constructor.js\";\nimport \"core-js/modules/es.iterator.find.js\";\nimport \"core-js/modules/es.iterator.map.js\";\nimport weatherService from '@/services/weather';\nimport xfyunService from '@/services/xfyun';\nconst state = {\n  messages: [],\n  isTyping: false,\n  currentEmotion: 'neutral',\n  weatherInfo: null,\n  soundEnabled: true\n};\nconst getters = {\n  messages: state => state.messages,\n  isTyping: state => state.isTyping,\n  currentEmotion: state => state.currentEmotion,\n  weatherInfo: state => state.weatherInfo\n};\nconst mutations = {\n  addMessage(state, message) {\n    if (!message || !message.text) return;\n    state.messages.push(message);\n  },\n  setTyping(state, isTyping) {\n    state.isTyping = isTyping;\n  },\n  setEmotion(state, emotion) {\n    state.currentEmotion = emotion;\n  },\n  setWeatherInfo(state, info) {\n    state.weatherInfo = info;\n  },\n  toggleSound(state) {\n    state.soundEnabled = !state.soundEnabled;\n  },\n  clearMessages(state) {\n    state.messages = [];\n    state.currentEmotion = 'neutral';\n    state.weatherInfo = null;\n  }\n};\n\n// 城市别名映射表\nconst cityAliases = {\n  '京': '北京',\n  '沪': '上海',\n  '宁': '南京',\n  '魔都': '上海',\n  '帝都': '北京',\n  '南都': '南京'\n};\n\n// 模糊匹配城市名称\nfunction fuzzyMatchCity(text) {\n  if (!text) return null;\n\n  // 首先检查完整城市名\n  for (const city of weatherService.defaultCities) {\n    if (text.includes(city.name)) {\n      return city;\n    }\n  }\n\n  // 检查城市别名\n  for (const [alias, cityName] of Object.entries(cityAliases)) {\n    if (text.includes(alias)) {\n      return weatherService.defaultCities.find(city => city.name === cityName);\n    }\n  }\n\n  // 提取可能的城市名（匹配1-4个汉字）\n  const possibleCities = text.match(/[\\u4e00-\\u9fa5]{1,4}(?:市|区|县)?/g) || [];\n  for (const possibleCity of possibleCities) {\n    // 移除\"市\"、\"区\"、\"县\"等后缀\n    const cleanName = possibleCity.replace(/[市区县]$/, '');\n\n    // 检查是否匹配任何已知城市\n    const matchedCity = weatherService.defaultCities.find(city => city.name.includes(cleanName) || cleanName.includes(city.name));\n    if (matchedCity) {\n      return matchedCity;\n    }\n  }\n  return null;\n}\nconst actions = {\n  async sendMessage({\n    commit\n  }, {\n    text,\n    type = 'user'\n  }) {\n    if (!text) return;\n    try {\n      // 添加用户消息\n      commit('addMessage', {\n        text,\n        type\n      });\n      if (type === 'user') {\n        commit('setTyping', true);\n        try {\n          // 分析情绪\n          const emotionResult = await xfyunService.analyzeEmotion(text);\n          commit('setEmotion', emotionResult);\n          console.log('[聊天] 情绪分析结果:', emotionResult);\n        } catch (error) {\n          console.error('[聊天] 情绪分析失败:', error);\n          commit('setEmotion', 'neutral');\n        }\n\n        // 检查是否是天气查询\n        const weatherPattern = /(查|问|看|怎么样|如何|天气|温度|冷|热|多少度)/;\n        let response = '';\n        if (weatherPattern.test(text)) {\n          console.log('[聊天] 检测到天气查询');\n\n          // 使用模糊匹配查找城市\n          const cityInfo = fuzzyMatchCity(text);\n          if (cityInfo) {\n            console.log('[聊天] 匹配到城市信息:', cityInfo);\n            try {\n              const weatherInfo = await weatherService.switchCity(cityInfo.id);\n              if (weatherInfo) {\n                commit('setWeatherInfo', weatherInfo);\n                response = weatherService.generateWeatherDescription(weatherInfo);\n              } else {\n                response = '抱歉，获取天气信息失败了，请稍后再试~';\n              }\n            } catch (error) {\n              console.error('[聊天] 获取天气失败:', error);\n              response = '抱歉，获取天气信息时出错了，请稍后再试~';\n            }\n          } else {\n            response = `抱歉，我目前只能查询这些城市的天气信息：${weatherService.defaultCities.map(c => c.name).join('、')}`;\n          }\n        } else {\n          // 根据情绪生成回复\n          response = generateResponse(text, state.currentEmotion);\n        }\n\n        // 添加助手回复\n        setTimeout(() => {\n          commit('setTyping', false);\n          commit('addMessage', {\n            text: response,\n            type: 'assistant'\n          });\n        }, 1000);\n      }\n    } catch (error) {\n      console.error('[聊天] 发送消息出错:', error);\n      commit('setTyping', false);\n      commit('addMessage', {\n        text: '抱歉，我遇到了一些问题，请稍后再试~',\n        type: 'assistant'\n      });\n    }\n  },\n  // 清空聊天记录\n  clearChat({\n    commit\n  }) {\n    commit('clearMessages');\n  }\n};\n\n// 根据情绪生成回复\nfunction generateResponse(text, emotion) {\n  const responses = {\n    positive: ['真好啊！我也感觉很开心呢~ 😊', '你的心情真不错，让我也变得愉快起来了！✨', '太棒了！保持这种好心情哦~ 🌟'],\n    negative: ['别担心，事情总会变好的~ 🌈', '我在这里陪着你呢，要加油哦！💪', '让我们一起想想开心的事吧~ 🌺'],\n    neutral: ['嗯嗯，我明白你的意思~ 🎈', '确实是这样呢！💫', '让我们继续聊下去吧~ ⭐']\n  };\n  const defaultResponses = responses[emotion] || responses.neutral;\n  return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];\n}\nexport default {\n  namespaced: true,\n  state,\n  getters,\n  mutations,\n  actions\n};","map":{"version":3,"names":["weatherService","xfyunService","state","messages","isTyping","currentEmotion","weatherInfo","soundEnabled","getters","mutations","addMessage","message","text","push","setTyping","setEmotion","emotion","setWeatherInfo","info","toggleSound","clearMessages","cityAliases","fuzzyMatchCity","city","defaultCities","includes","name","alias","cityName","Object","entries","find","possibleCities","match","possibleCity","cleanName","replace","matchedCity","actions","sendMessage","commit","type","emotionResult","analyzeEmotion","console","log","error","weatherPattern","response","test","cityInfo","switchCity","id","generateWeatherDescription","map","c","join","generateResponse","setTimeout","clearChat","responses","positive","negative","neutral","defaultResponses","Math","floor","random","length","namespaced"],"sources":["E:/code/PersonalBolg1/frontend/src/store/modules/chat.js"],"sourcesContent":["import weatherService from '@/services/weather';\nimport xfyunService from '@/services/xfyun';\n\nconst state = {\n  messages: [],\n  isTyping: false,\n  currentEmotion: 'neutral',\n  weatherInfo: null,\n  soundEnabled: true\n};\n\nconst getters = {\n  messages: state => state.messages,\n  isTyping: state => state.isTyping,\n  currentEmotion: state => state.currentEmotion,\n  weatherInfo: state => state.weatherInfo\n};\n\nconst mutations = {\n  addMessage(state, message) {\n    if (!message || !message.text) return;\n    state.messages.push(message);\n  },\n  setTyping(state, isTyping) {\n    state.isTyping = isTyping;\n  },\n  setEmotion(state, emotion) {\n    state.currentEmotion = emotion;\n  },\n  setWeatherInfo(state, info) {\n    state.weatherInfo = info;\n  },\n  toggleSound(state) {\n    state.soundEnabled = !state.soundEnabled;\n  },\n  clearMessages(state) {\n    state.messages = [];\n    state.currentEmotion = 'neutral';\n    state.weatherInfo = null;\n  }\n};\n\n// 城市别名映射表\nconst cityAliases = {\n  '京': '北京',\n  '沪': '上海',\n  '宁': '南京',\n  '魔都': '上海',\n  '帝都': '北京',\n  '南都': '南京'\n};\n\n// 模糊匹配城市名称\nfunction fuzzyMatchCity(text) {\n  if (!text) return null;\n\n  // 首先检查完整城市名\n  for (const city of weatherService.defaultCities) {\n    if (text.includes(city.name)) {\n      return city;\n    }\n  }\n\n  // 检查城市别名\n  for (const [alias, cityName] of Object.entries(cityAliases)) {\n    if (text.includes(alias)) {\n      return weatherService.defaultCities.find(city => city.name === cityName);\n    }\n  }\n\n  // 提取可能的城市名（匹配1-4个汉字）\n  const possibleCities = text.match(/[\\u4e00-\\u9fa5]{1,4}(?:市|区|县)?/g) || [];\n  \n  for (const possibleCity of possibleCities) {\n    // 移除\"市\"、\"区\"、\"县\"等后缀\n    const cleanName = possibleCity.replace(/[市区县]$/, '');\n    \n    // 检查是否匹配任何已知城市\n    const matchedCity = weatherService.defaultCities.find(city => \n      city.name.includes(cleanName) || cleanName.includes(city.name)\n    );\n    \n    if (matchedCity) {\n      return matchedCity;\n    }\n  }\n\n  return null;\n}\n\nconst actions = {\n  async sendMessage({ commit }, { text, type = 'user' }) {\n    if (!text) return;\n\n    try {\n      // 添加用户消息\n      commit('addMessage', { text, type });\n      \n      if (type === 'user') {\n        commit('setTyping', true);\n        \n        try {\n          // 分析情绪\n          const emotionResult = await xfyunService.analyzeEmotion(text);\n          commit('setEmotion', emotionResult);\n          console.log('[聊天] 情绪分析结果:', emotionResult);\n        } catch (error) {\n          console.error('[聊天] 情绪分析失败:', error);\n          commit('setEmotion', 'neutral');\n        }\n\n        // 检查是否是天气查询\n        const weatherPattern = /(查|问|看|怎么样|如何|天气|温度|冷|热|多少度)/;\n        let response = '';\n\n        if (weatherPattern.test(text)) {\n          console.log('[聊天] 检测到天气查询');\n          \n          // 使用模糊匹配查找城市\n          const cityInfo = fuzzyMatchCity(text);\n          \n          if (cityInfo) {\n            console.log('[聊天] 匹配到城市信息:', cityInfo);\n            try {\n              const weatherInfo = await weatherService.switchCity(cityInfo.id);\n              if (weatherInfo) {\n                commit('setWeatherInfo', weatherInfo);\n                response = weatherService.generateWeatherDescription(weatherInfo);\n              } else {\n                response = '抱歉，获取天气信息失败了，请稍后再试~';\n              }\n            } catch (error) {\n              console.error('[聊天] 获取天气失败:', error);\n              response = '抱歉，获取天气信息时出错了，请稍后再试~';\n            }\n          } else {\n            response = `抱歉，我目前只能查询这些城市的天气信息：${weatherService.defaultCities.map(c => c.name).join('、')}`;\n          }\n        } else {\n          // 根据情绪生成回复\n          response = generateResponse(text, state.currentEmotion);\n        }\n\n        // 添加助手回复\n        setTimeout(() => {\n          commit('setTyping', false);\n          commit('addMessage', { text: response, type: 'assistant' });\n        }, 1000);\n      }\n    } catch (error) {\n      console.error('[聊天] 发送消息出错:', error);\n      commit('setTyping', false);\n      commit('addMessage', {\n        text: '抱歉，我遇到了一些问题，请稍后再试~',\n        type: 'assistant'\n      });\n    }\n  },\n\n  // 清空聊天记录\n  clearChat({ commit }) {\n    commit('clearMessages');\n  }\n};\n\n// 根据情绪生成回复\nfunction generateResponse(text, emotion) {\n  const responses = {\n    positive: [\n      '真好啊！我也感觉很开心呢~ 😊',\n      '你的心情真不错，让我也变得愉快起来了！✨',\n      '太棒了！保持这种好心情哦~ 🌟'\n    ],\n    negative: [\n      '别担心，事情总会变好的~ 🌈',\n      '我在这里陪着你呢，要加油哦！💪',\n      '让我们一起想想开心的事吧~ 🌺'\n    ],\n    neutral: [\n      '嗯嗯，我明白你的意思~ 🎈',\n      '确实是这样呢！💫',\n      '让我们继续聊下去吧~ ⭐'\n    ]\n  };\n\n  const defaultResponses = responses[emotion] || responses.neutral;\n  return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];\n}\n\nexport default {\n  namespaced: true,\n  state,\n  getters,\n  mutations,\n  actions\n};"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}