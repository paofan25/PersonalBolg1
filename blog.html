<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœ¨ åšå®¢ - å°å¯çˆ±ã®ä¸»é¡µ âœ¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./css/style.css">
    <style>
        .blog-container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 1rem;
        }

        .blog-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .blog-title {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }

        .blog-description {
            font-size: 1.1rem;
            color: #666;
        }

        .blog-posts {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 2rem;
        }

        .post-card {
            background: white;
            border-radius: 1rem;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(255, 158, 205, 0.2);
            transition: all 0.3s ease;
        }

        .post-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(255, 158, 205, 0.3);
        }

        .post-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }

        .post-content {
            padding: 1.5rem;
        }

        .post-title {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 0.8rem;
        }

        .post-excerpt {
            color: #666;
            margin-bottom: 1rem;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .post-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            color: #999;
        }

        .post-date {
            font-style: italic;
        }

        .post-stats {
            display: flex;
            gap: 1rem;
        }

        .post-tag {
            display: inline-block;
            background: #f0f0f0;
            padding: 0.3rem 0.8rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            color: #666;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .post-tags {
            margin-bottom: 1rem;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 3rem;
        }

        .pagination button {
            padding: 0.5rem 1rem;
            border: none;
            background: white;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .pagination button:hover,
        .pagination button.active {
            background: var(--primary-color);
            color: white;
        }

        .pagination button:disabled {
            background: #f0f0f0;
            color: #999;
            cursor: not-allowed;
        }

        .create-post-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            box-shadow: 0 4px 15px rgba(255, 158, 205, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 100;
        }

        .create-post-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(255, 158, 205, 0.4);
        }

        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .post-form .form-group {
            margin-bottom: 1.5rem;
        }

        .post-form label {
            display: block;
            margin-bottom: 0.5rem;
            color: #666;
        }

        .post-form input,
        .post-form textarea {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #f0f0f0;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        .post-form textarea {
            height: 200px;
            resize: vertical;
        }

        .post-form button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            float: right;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        .no-posts {
            text-align: center;
            padding: 3rem;
            color: #999;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="nav-bar">
        <a href="./index.html" class="logo">
            <img src="https://api.dicebear.com/7.x/adventurer/svg?seed=flower" alt="Logo">
            å°å¯çˆ±ã®ä¸»é¡µ
        </a>
        <div class="nav-links">
            <a href="./index.html">é¦–é¡µ</a>
            <a href="./blog.html">åšå®¢</a>
            <a href="./works.html">ä½œå“</a>
            <a href="./message.html">ç•™è¨€æ¿</a>
            <div class="games-group">
                <a href="#" id="gamesBtn">å°æ¸¸æˆ â–¾</a>
                <div class="games-menu" id="gamesMenu">
                    <a href="./games/snake.html">â™¡ è´ªåƒè›‡</a>
                    <a href="./games/memory.html">â™¡ è®°å¿†é…å¯¹</a>
                    <a href="./games/puzzle.html">â™¡ æ‹¼å›¾æ¸¸æˆ</a>
                </div>
            </div>
            <a href="#" class="login-btn" id="loginBtn">ç™»å½•/æ³¨å†Œ</a>
            <div class="user-menu" id="userMenu" style="display: none;">
                <img src="" alt="" id="userAvatar" class="user-avatar">
                <div class="user-dropdown">
                    <a href="./profile.html">ä¸ªäººèµ„æ–™</a>
                    <a href="#" id="logoutBtn">é€€å‡ºç™»å½•</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- åšå®¢å†…å®¹ -->
    <div class="blog-container">
        <div class="blog-header">
            <h1 class="blog-title">âœ¨ æˆ‘çš„åšå®¢ âœ¨</h1>
            <p class="blog-description">åˆ†äº«æˆ‘çš„æƒ³æ³•ã€ç»éªŒå’Œç”Ÿæ´»ç‚¹æ»´</p>
        </div>

        <div class="blog-posts" id="blogPosts">
            <!-- åšå®¢æ–‡ç« å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div class="pagination" id="pagination">
            <!-- åˆ†é¡µæŒ‰é’®å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- åˆ›å»ºæ–‡ç« æŒ‰é’® -->
    <div class="create-post-btn" id="createPostBtn">+</div>

    <!-- åˆ›å»ºæ–‡ç« æ¨¡æ€æ¡† -->
    <div class="modal" id="createPostModal">
        <div class="modal-content">
            <span class="modal-close" id="closePostModal">&times;</span>
            <h2 class="modal-title">åˆ›å»ºæ–°æ–‡ç« </h2>
            <form class="post-form" id="postForm">
                <div class="form-group">
                    <label for="postTitle">æ ‡é¢˜</label>
                    <input type="text" id="postTitle" placeholder="è¯·è¾“å…¥æ–‡ç« æ ‡é¢˜" required>
                </div>
                <div class="form-group">
                    <label for="postCover">å°é¢å›¾ç‰‡URL</label>
                    <input type="text" id="postCover" placeholder="è¯·è¾“å…¥å°é¢å›¾ç‰‡URL">
                </div>
                <div class="form-group">
                    <label for="postTags">æ ‡ç­¾ï¼ˆç”¨é€—å·åˆ†éš”ï¼‰</label>
                    <input type="text" id="postTags" placeholder="ä¾‹å¦‚ï¼šç¼–ç¨‹,ç”Ÿæ´»,å‰ç«¯">
                </div>
                <div class="form-group">
                    <label for="postContent">å†…å®¹</label>
                    <textarea id="postContent" placeholder="è¯·è¾“å…¥æ–‡ç« å†…å®¹..." required></textarea>
                </div>
                <button type="submit">å‘å¸ƒæ–‡ç« </button>
            </form>
        </div>
    </div>

    <!-- ç™»å½•è¡¨å•æ¨¡æ€æ¡† -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <span class="modal-close" id="closeLoginModal">&times;</span>
            <h2 class="modal-title">ç™»å½•</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">ç”¨æˆ·å</label>
                    <input type="text" id="username" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                </div>
                <div class="form-group">
                    <label for="password">å¯†ç </label>
                    <input type="password" id="password" placeholder="è¯·è¾“å…¥å¯†ç " required>
                </div>
                <button type="submit">ç™»å½•</button>
                <p style="text-align: center; margin-top: 1rem;">
                    è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ<a href="#" id="showRegister">ç«‹å³æ³¨å†Œ</a>
                </p>
            </form>
        </div>
    </div>

    <!-- æ³¨å†Œè¡¨å•æ¨¡æ€æ¡† -->
    <div class="modal" id="registerModal">
        <div class="modal-content">
            <span class="modal-close" id="closeRegisterModal">&times;</span>
            <h2 class="modal-title">æ³¨å†Œ</h2>
            <form id="registerForm">
                <div class="form-group">
                    <label for="regUsername">ç”¨æˆ·å</label>
                    <input type="text" id="regUsername" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                </div>
                <div class="form-group">
                    <label for="regEmail">é‚®ç®±</label>
                    <input type="email" id="regEmail" placeholder="è¯·è¾“å…¥é‚®ç®±" required>
                </div>
                <div class="form-group">
                    <label for="regPassword">å¯†ç </label>
                    <input type="password" id="regPassword" placeholder="è¯·è¾“å…¥å¯†ç " required>
                </div>
                <div class="form-group">
                    <label for="regConfirmPassword">ç¡®è®¤å¯†ç </label>
                    <input type="password" id="regConfirmPassword" placeholder="è¯·å†æ¬¡è¾“å…¥å¯†ç " required>
                </div>
                <button type="submit">æ³¨å†Œ</button>
                <p style="text-align: center; margin-top: 1rem;">
                    å·²æœ‰è´¦å·ï¼Ÿ<a href="#" id="showLogin">ç«‹å³ç™»å½•</a>
                </p>
            </form>
        </div>
    </div>

    <script type="module">
        import { blogService, authService } from './js/backend/index.js';

        document.addEventListener('DOMContentLoaded', () => {
            // å…¨å±€å˜é‡
            let currentPage = 1;
            const postsPerPage = 6;

            // DOMå…ƒç´ 
            const blogPostsContainer = document.getElementById('blogPosts');
            const paginationContainer = document.getElementById('pagination');
            const createPostBtn = document.getElementById('createPostBtn');
            const createPostModal = document.getElementById('createPostModal');
            const closePostModal = document.getElementById('closePostModal');
            const postForm = document.getElementById('postForm');
            const loginBtn = document.getElementById('loginBtn');
            const userMenu = document.getElementById('userMenu');
            const userAvatar = document.getElementById('userAvatar');
            const logoutBtn = document.getElementById('logoutBtn');
            const loginModal = document.getElementById('loginModal');
            const registerModal = document.getElementById('registerModal');
            const closeLoginModal = document.getElementById('closeLoginModal');
            const closeRegisterModal = document.getElementById('closeRegisterModal');
            const showRegister = document.getElementById('showRegister');
            const showLogin = document.getElementById('showLogin');
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const gamesBtn = document.getElementById('gamesBtn');
            const gamesMenu = document.getElementById('gamesMenu');

            // åŠ è½½åšå®¢æ–‡ç« 
            function loadPosts() {
                try {
                    const result = blogService.getAllPosts(currentPage, postsPerPage);
                    const { posts, totalPages } = result;

                    // æ¸…ç©ºå†…å®¹
                    blogPostsContainer.innerHTML = '';

                    if (posts.length === 0) {
                        blogPostsContainer.innerHTML = '<div class="no-posts">æš‚æ— æ–‡ç« ï¼Œå¿«æ¥å‘å¸ƒç¬¬ä¸€ç¯‡å§ï¼</div>';
                        return;
                    }

                    // æ¸²æŸ“æ–‡ç« 
                    posts.forEach(post => {
                        // è·å–æ–‡ç« ä½œè€…ä¿¡æ¯
                        const author = post.author || { username: 'æœªçŸ¥ç”¨æˆ·' };
                        
                        // åˆ›å»ºæ–‡ç« å¡ç‰‡
                        const postCard = document.createElement('div');
                        postCard.className = 'post-card';
                        
                        // è®¾ç½®å°é¢å›¾ç‰‡
                        const coverImage = post.coverImage || 'https://source.unsplash.com/random/800x600/?blog';
                        
                        // æå–æ‘˜è¦
                        const excerpt = post.content.replace(/<\/?[^>]+(>|$)/g, "").substring(0, 120) + '...';
                        
                        // æ ¼å¼åŒ–æ—¥æœŸ
                        const date = new Date(post.createdAt);
                        const formattedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
                        
                        // è®¾ç½®æ–‡ç« HTML
                        postCard.innerHTML = `
                            <img src="${coverImage}" alt="${post.title}" class="post-image">
                            <div class="post-content">
                                <h2 class="post-title">${post.title}</h2>
                                <div class="post-tags">
                                    ${post.tags.map(tag => `<span class="post-tag">${tag}</span>`).join('')}
                                </div>
                                <p class="post-excerpt">${excerpt}</p>
                                <div class="post-meta">
                                    <span class="post-date">${formattedDate}</span>
                                    <div class="post-stats">
                                        <span>ğŸ‘ï¸ ${post.views || 0}</span>
                                        <span>â¤ï¸ ${post.likes || 0}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶ï¼Œè·³è½¬åˆ°æ–‡ç« è¯¦æƒ…é¡µ
                        postCard.addEventListener('click', () => {
                            window.location.href = `./post.html?id=${post.id}`;
                        });
                        
                        // æ·»åŠ åˆ°å®¹å™¨
                        blogPostsContainer.appendChild(postCard);
                    });

                    // æ¸²æŸ“åˆ†é¡µ
                    renderPagination(totalPages);
                } catch (error) {
                    console.error('åŠ è½½æ–‡ç« å¤±è´¥:', error);
                    blogPostsContainer.innerHTML = `<div class="no-posts">åŠ è½½æ–‡ç« å¤±è´¥: ${error.message}</div>`;
                }
            }

            // æ¸²æŸ“åˆ†é¡µ
            function renderPagination(totalPages) {
                paginationContainer.innerHTML = '';
                
                if (totalPages <= 1) return;

                // ä¸Šä¸€é¡µæŒ‰é’®
                const prevButton = document.createElement('button');
                prevButton.textContent = 'ä¸Šä¸€é¡µ';
                prevButton.disabled = currentPage === 1;
                prevButton.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        loadPosts();
                    }
                });
                paginationContainer.appendChild(prevButton);

                // é¡µç æŒ‰é’®
                for (let i = 1; i <= totalPages; i++) {
                    const pageButton = document.createElement('button');
                    pageButton.textContent = i;
                    pageButton.className = i === currentPage ? 'active' : '';
                    pageButton.addEventListener('click', () => {
                        currentPage = i;
                        loadPosts();
                    });
                    paginationContainer.appendChild(pageButton);
                }

                // ä¸‹ä¸€é¡µæŒ‰é’®
                const nextButton = document.createElement('button');
                nextButton.textContent = 'ä¸‹ä¸€é¡µ';
                nextButton.disabled = currentPage === totalPages;
                nextButton.addEventListener('click', () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        loadPosts();
                    }
                });
                paginationContainer.appendChild(nextButton);
            }

            // åˆ›å»ºæ–‡ç« 
            function createPost(event) {
                event.preventDefault();
                
                if (!authService.isLoggedIn()) {
                    alert('è¯·å…ˆç™»å½•');
                    loginModal.style.display = 'flex';
                    return;
                }
                
                const title = document.getElementById('postTitle').value;
                const content = document.getElementById('postContent').value;
                const coverImage = document.getElementById('postCover').value;
                const tagsInput = document.getElementById('postTags').value;
                const tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag);
                
                try {
                    blogService.createPost({
                        title,
                        content,
                        coverImage,
                        tags
                    });
                    
                    // é‡ç½®è¡¨å•
                    postForm.reset();
                    
                    // å…³é—­æ¨¡æ€æ¡†
                    createPostModal.style.display = 'none';
                    
                    // é‡æ–°åŠ è½½æ–‡ç« 
                    currentPage = 1;
                    loadPosts();
                    
                    alert('æ–‡ç« å‘å¸ƒæˆåŠŸï¼');
                } catch (error) {
                    alert(`å‘å¸ƒå¤±è´¥: ${error.message}`);
                }
            }

            // åˆå§‹åŒ–è®¤è¯çŠ¶æ€
            function initAuthState() {
                if (authService.isLoggedIn()) {
                    const user = authService.getCurrentUser();
                    userAvatar.src = user.avatar;
                    userAvatar.alt = user.username;
                    loginBtn.style.display = 'none';
                    userMenu.style.display = 'flex';
                } else {
                    loginBtn.style.display = 'flex';
                    userMenu.style.display = 'none';
                }
            }

            // ç™»å½•å‡½æ•°
            function login(event) {
                event.preventDefault();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                try {
                    authService.login(username, password);
                    loginModal.style.display = 'none';
                    initAuthState();
                    alert('ç™»å½•æˆåŠŸï¼');
                } catch (error) {
                    alert(`ç™»å½•å¤±è´¥: ${error.message}`);
                }
            }

            // æ³¨å†Œå‡½æ•°
            function register(event) {
                event.preventDefault();
                
                const username = document.getElementById('regUsername').value;
                const email = document.getElementById('regEmail').value;
                const password = document.getElementById('regPassword').value;
                const confirmPassword = document.getElementById('regConfirmPassword').value;
                
                try {
                    authService.register({
                        username,
                        email,
                        password,
                        confirmPassword
                    });
                    registerModal.style.display = 'none';
                    initAuthState();
                    alert('æ³¨å†ŒæˆåŠŸï¼');
                } catch (error) {
                    alert(`æ³¨å†Œå¤±è´¥: ${error.message}`);
                }
            }

            // äº‹ä»¶ç›‘å¬
            createPostBtn.addEventListener('click', () => {
                if (!authService.isLoggedIn()) {
                    alert('è¯·å…ˆç™»å½•');
                    loginModal.style.display = 'flex';
                    return;
                }
                createPostModal.style.display = 'flex';
            });

            closePostModal.addEventListener('click', () => {
                createPostModal.style.display = 'none';
            });

            postForm.addEventListener('submit', createPost);

            loginBtn.addEventListener('click', () => {
                loginModal.style.display = 'flex';
            });

            closeLoginModal.addEventListener('click', () => {
                loginModal.style.display = 'none';
            });

            closeRegisterModal.addEventListener('click', () => {
                registerModal.style.display = 'none';
            });

            showRegister.addEventListener('click', () => {
                loginModal.style.display = 'none';
                registerModal.style.display = 'flex';
            });

            showLogin.addEventListener('click', () => {
                registerModal.style.display = 'none';
                loginModal.style.display = 'flex';
            });

            loginForm.addEventListener('submit', login);
            registerForm.addEventListener('submit', register);

            logoutBtn.addEventListener('click', () => {
                authService.logout();
                initAuthState();
                alert('å·²æˆåŠŸé€€å‡ºç™»å½•');
            });

            // æ¸¸æˆèœå•äº¤äº’
            let isGamesMenuVisible = false;
            gamesBtn.addEventListener('click', (e) => {
                e.preventDefault();
                isGamesMenuVisible = !isGamesMenuVisible;
                gamesMenu.style.display = isGamesMenuVisible ? 'block' : 'none';
            });

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­å„ç§æ¨¡æ€æ¡†å’Œèœå•
            window.addEventListener('click', (e) => {
                if (e.target === createPostModal) {
                    createPostModal.style.display = 'none';
                }
                if (e.target === loginModal) {
                    loginModal.style.display = 'none';
                }
                if (e.target === registerModal) {
                    registerModal.style.display = 'none';
                }
                if (!gamesBtn.contains(e.target) && !gamesMenu.contains(e.target)) {
                    gamesMenu.style.display = 'none';
                    isGamesMenuVisible = false;
                }
            });

            // åˆå§‹åŒ–
            initAuthState();
            loadPosts();
        });
    </script>
</body>
</html>